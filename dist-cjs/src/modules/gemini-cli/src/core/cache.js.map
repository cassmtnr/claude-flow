{"version":3,"sources":["../../../../../../src/modules/gemini-cli/src/core/cache.ts"],"sourcesContent":["/**\n * Gemini CLI Module - Cache Manager\n * LRU cache with file persistence\n */\n\nimport * as fs from 'fs/promises';\nimport * as path from 'path';\nimport * as crypto from 'crypto';\nimport type { CacheConfig, AnalysisResult } from './types.js';\n\ninterface CacheEntry {\n  key: string;\n  value: AnalysisResult;\n  createdAt: number;\n  accessedAt: number;\n  size: number;\n}\n\nexport class GeminiCache {\n  private cache: Map<string, CacheEntry> = new Map();\n  private config: CacheConfig;\n  private initialized: boolean = false;\n\n  constructor(config: CacheConfig) {\n    this.config = config;\n  }\n\n  /**\n   * Initialize cache directory\n   */\n  async initialize(): Promise<void> {\n    if (!this.config.enabled || this.initialized) return;\n\n    try {\n      await fs.mkdir(this.config.directory, { recursive: true });\n      await this.loadFromDisk();\n      this.initialized = true;\n    } catch (error) {\n      console.warn('Failed to initialize cache:', error);\n    }\n  }\n\n  /**\n   * Generate cache key from request parameters\n   */\n  generateKey(params: Record<string, unknown>): string {\n    const normalized = JSON.stringify(params, Object.keys(params).sort());\n    return crypto.createHash('sha256').update(normalized).digest('hex').slice(0, 16);\n  }\n\n  /**\n   * Get cached result\n   */\n  async get(key: string): Promise<AnalysisResult | null> {\n    if (!this.config.enabled) return null;\n\n    const entry = this.cache.get(key);\n    if (!entry) return null;\n\n    // Check TTL\n    if (Date.now() - entry.createdAt > this.config.ttl) {\n      this.cache.delete(key);\n      await this.removeFromDisk(key);\n      return null;\n    }\n\n    // Update access time (LRU)\n    entry.accessedAt = Date.now();\n    return entry.value;\n  }\n\n  /**\n   * Set cached result\n   */\n  async set(key: string, value: AnalysisResult): Promise<void> {\n    if (!this.config.enabled) return;\n\n    const size = JSON.stringify(value).length;\n\n    // Evict if necessary\n    await this.evictIfNeeded();\n\n    const entry: CacheEntry = {\n      key,\n      value,\n      createdAt: Date.now(),\n      accessedAt: Date.now(),\n      size,\n    };\n\n    this.cache.set(key, entry);\n    await this.saveToDisk(key, entry);\n  }\n\n  /**\n   * Invalidate cache entries matching pattern\n   */\n  async invalidate(pattern?: { target?: string; type?: string }): Promise<number> {\n    let invalidated = 0;\n\n    for (const [key, entry] of Array.from(this.cache.entries())) {\n      let shouldInvalidate = !pattern;\n\n      if (pattern) {\n        const value = entry.value;\n        if (pattern.target && value.requestId?.includes(pattern.target)) {\n          shouldInvalidate = true;\n        }\n        if (pattern.type && value.findings?.some(f => f.type === pattern.type)) {\n          shouldInvalidate = true;\n        }\n      }\n\n      if (shouldInvalidate) {\n        this.cache.delete(key);\n        await this.removeFromDisk(key);\n        invalidated++;\n      }\n    }\n\n    return invalidated;\n  }\n\n  /**\n   * Clear all cache\n   */\n  async clear(): Promise<void> {\n    this.cache.clear();\n\n    try {\n      const files = await fs.readdir(this.config.directory);\n      await Promise.all(\n        files\n          .filter(f => f.endsWith('.json'))\n          .map(f => fs.unlink(path.join(this.config.directory, f)))\n      );\n    } catch {\n      // Ignore errors during clear\n    }\n  }\n\n  /**\n   * Get cache statistics\n   */\n  getStats(): { entries: number; size: number; hitRate: number } {\n    let totalSize = 0;\n    for (const entry of Array.from(this.cache.values())) {\n      totalSize += entry.size;\n    }\n\n    return {\n      entries: this.cache.size,\n      size: totalSize,\n      hitRate: 0, // Would need to track hits/misses\n    };\n  }\n\n  /**\n   * Evict least recently used entries if needed\n   */\n  private async evictIfNeeded(): Promise<void> {\n    while (this.cache.size >= this.config.maxSize) {\n      // Find LRU entry\n      let lruKey: string | null = null;\n      let lruTime = Infinity;\n\n      for (const [key, entry] of Array.from(this.cache.entries())) {\n        if (entry.accessedAt < lruTime) {\n          lruTime = entry.accessedAt;\n          lruKey = key;\n        }\n      }\n\n      if (lruKey) {\n        this.cache.delete(lruKey);\n        await this.removeFromDisk(lruKey);\n      } else {\n        break;\n      }\n    }\n  }\n\n  /**\n   * Save entry to disk\n   */\n  private async saveToDisk(key: string, entry: CacheEntry): Promise<void> {\n    try {\n      const filePath = path.join(this.config.directory, `${key}.json`);\n      await fs.writeFile(filePath, JSON.stringify(entry), 'utf-8');\n    } catch (error) {\n      console.warn(`Failed to save cache entry ${key}:`, error);\n    }\n  }\n\n  /**\n   * Remove entry from disk\n   */\n  private async removeFromDisk(key: string): Promise<void> {\n    try {\n      const filePath = path.join(this.config.directory, `${key}.json`);\n      await fs.unlink(filePath);\n    } catch {\n      // Ignore if file doesn't exist\n    }\n  }\n\n  /**\n   * Load cache from disk on startup\n   */\n  private async loadFromDisk(): Promise<void> {\n    try {\n      const files = await fs.readdir(this.config.directory);\n      const jsonFiles = files.filter(f => f.endsWith('.json'));\n\n      for (const file of jsonFiles) {\n        try {\n          const filePath = path.join(this.config.directory, file);\n          const content = await fs.readFile(filePath, 'utf-8');\n          const entry: CacheEntry = JSON.parse(content);\n\n          // Check TTL\n          if (Date.now() - entry.createdAt <= this.config.ttl) {\n            this.cache.set(entry.key, entry);\n          } else {\n            await fs.unlink(filePath);\n          }\n        } catch {\n          // Skip invalid files\n        }\n      }\n    } catch {\n      // Directory might not exist yet\n    }\n  }\n}\n"],"names":["fs","path","crypto","GeminiCache","cache","Map","config","initialized","initialize","enabled","mkdir","directory","recursive","loadFromDisk","error","console","warn","generateKey","params","normalized","JSON","stringify","Object","keys","sort","createHash","update","digest","slice","get","key","entry","Date","now","createdAt","ttl","delete","removeFromDisk","accessedAt","value","set","size","length","evictIfNeeded","saveToDisk","invalidate","pattern","invalidated","Array","from","entries","shouldInvalidate","target","requestId","includes","type","findings","some","f","clear","files","readdir","Promise","all","filter","endsWith","map","unlink","join","getStats","totalSize","values","hitRate","maxSize","lruKey","lruTime","Infinity","filePath","writeFile","jsonFiles","file","content","readFile","parse"],"mappings":"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"}