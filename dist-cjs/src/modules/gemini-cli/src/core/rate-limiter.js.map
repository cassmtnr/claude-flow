{"version":3,"sources":["../../../../../../src/modules/gemini-cli/src/core/rate-limiter.ts"],"sourcesContent":["/**\n * Gemini CLI Module - Rate Limiter\n * Token bucket algorithm implementation\n */\n\nimport { GeminiRateLimitError } from './errors.js';\nimport type { RateLimitConfig, QuotaStatus } from './types.js';\n\ninterface TokenBucket {\n  tokens: number;\n  lastRefill: number;\n  capacity: number;\n  refillRate: number; // tokens per ms\n}\n\nexport class RateLimiter {\n  private minuteBucket: TokenBucket;\n  private dayBucket: TokenBucket;\n  private config: RateLimitConfig;\n\n  constructor(config: RateLimitConfig) {\n    this.config = config;\n\n    // Initialize minute bucket\n    this.minuteBucket = {\n      tokens: config.requestsPerMinute,\n      lastRefill: Date.now(),\n      capacity: config.requestsPerMinute,\n      refillRate: config.requestsPerMinute / 60000, // per ms\n    };\n\n    // Initialize day bucket\n    this.dayBucket = {\n      tokens: config.requestsPerDay,\n      lastRefill: Date.now(),\n      capacity: config.requestsPerDay,\n      refillRate: config.requestsPerDay / 86400000, // per ms\n    };\n  }\n\n  /**\n   * Check if a request can be made\n   */\n  canMakeRequest(): boolean {\n    if (!this.config.enabled) return true;\n\n    this.refillBuckets();\n    return this.minuteBucket.tokens >= 1 && this.dayBucket.tokens >= 1;\n  }\n\n  /**\n   * Consume a token (call after successful request)\n   */\n  consumeToken(): void {\n    if (!this.config.enabled) return;\n\n    this.refillBuckets();\n\n    if (this.minuteBucket.tokens < 1 || this.dayBucket.tokens < 1) {\n      const retryAfter = this.getRetryAfter();\n      throw new GeminiRateLimitError(\n        'Rate limit exceeded',\n        retryAfter,\n        { quota: this.getQuotaStatus() }\n      );\n    }\n\n    this.minuteBucket.tokens -= 1;\n    this.dayBucket.tokens -= 1;\n  }\n\n  /**\n   * Wait until a request can be made\n   */\n  async waitForQuota(): Promise<void> {\n    if (!this.config.enabled) return;\n\n    while (!this.canMakeRequest()) {\n      const waitTime = Math.min(this.getRetryAfter(), 60000); // Max 1 minute wait\n      await new Promise(resolve => setTimeout(resolve, waitTime));\n    }\n  }\n\n  /**\n   * Get current quota status\n   */\n  getQuotaStatus(): QuotaStatus {\n    this.refillBuckets();\n\n    const minuteResetAt = new Date(this.minuteBucket.lastRefill + 60000);\n    const dayResetAt = new Date(this.getDayResetTime());\n\n    return {\n      requestsPerMinute: {\n        used: Math.floor(this.minuteBucket.capacity - this.minuteBucket.tokens),\n        limit: this.minuteBucket.capacity,\n        resetAt: minuteResetAt,\n      },\n      requestsPerDay: {\n        used: Math.floor(this.dayBucket.capacity - this.dayBucket.tokens),\n        limit: this.dayBucket.capacity,\n        resetAt: dayResetAt,\n      },\n    };\n  }\n\n  /**\n   * Get time until next available request (ms)\n   */\n  getRetryAfter(): number {\n    this.refillBuckets();\n\n    if (this.minuteBucket.tokens < 1) {\n      // Time until minute bucket has 1 token\n      const tokensNeeded = 1 - this.minuteBucket.tokens;\n      return Math.ceil(tokensNeeded / this.minuteBucket.refillRate);\n    }\n\n    if (this.dayBucket.tokens < 1) {\n      // Time until day bucket has 1 token\n      const tokensNeeded = 1 - this.dayBucket.tokens;\n      return Math.ceil(tokensNeeded / this.dayBucket.refillRate);\n    }\n\n    return 0;\n  }\n\n  /**\n   * Refill token buckets based on elapsed time\n   */\n  private refillBuckets(): void {\n    const now = Date.now();\n\n    // Refill minute bucket\n    const minuteElapsed = now - this.minuteBucket.lastRefill;\n    const minuteTokensToAdd = minuteElapsed * this.minuteBucket.refillRate;\n    this.minuteBucket.tokens = Math.min(\n      this.minuteBucket.capacity,\n      this.minuteBucket.tokens + minuteTokensToAdd\n    );\n    this.minuteBucket.lastRefill = now;\n\n    // Refill day bucket\n    const dayElapsed = now - this.dayBucket.lastRefill;\n    const dayTokensToAdd = dayElapsed * this.dayBucket.refillRate;\n    this.dayBucket.tokens = Math.min(\n      this.dayBucket.capacity,\n      this.dayBucket.tokens + dayTokensToAdd\n    );\n    this.dayBucket.lastRefill = now;\n  }\n\n  /**\n   * Get the next day reset time (midnight UTC)\n   */\n  private getDayResetTime(): number {\n    const now = new Date();\n    const tomorrow = new Date(now);\n    tomorrow.setUTCDate(tomorrow.getUTCDate() + 1);\n    tomorrow.setUTCHours(0, 0, 0, 0);\n    return tomorrow.getTime();\n  }\n\n  /**\n   * Reset rate limits (for testing or manual reset)\n   */\n  reset(): void {\n    this.minuteBucket.tokens = this.minuteBucket.capacity;\n    this.minuteBucket.lastRefill = Date.now();\n    this.dayBucket.tokens = this.dayBucket.capacity;\n    this.dayBucket.lastRefill = Date.now();\n  }\n}\n"],"names":["GeminiRateLimitError","RateLimiter","minuteBucket","dayBucket","config","tokens","requestsPerMinute","lastRefill","Date","now","capacity","refillRate","requestsPerDay","canMakeRequest","enabled","refillBuckets","consumeToken","retryAfter","getRetryAfter","quota","getQuotaStatus","waitForQuota","waitTime","Math","min","Promise","resolve","setTimeout","minuteResetAt","dayResetAt","getDayResetTime","used","floor","limit","resetAt","tokensNeeded","ceil","minuteElapsed","minuteTokensToAdd","dayElapsed","dayTokensToAdd","tomorrow","setUTCDate","getUTCDate","setUTCHours","getTime","reset"],"mappings":"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"}