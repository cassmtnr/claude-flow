{"version":3,"sources":["../../../../../../src/modules/gemini-cli/src/core/index.ts"],"sourcesContent":["/**\n * Gemini CLI Module - Main Entry Point\n * Manages the complete lifecycle of the Gemini CLI integration\n */\n\nimport * as fs from 'fs/promises';\nimport * as path from 'path';\nimport * as os from 'os';\nimport { EventEmitter } from 'events';\nimport type {\n  GeminiCLIConfig,\n  ModuleStatus,\n  AuthMethod,\n  AnalysisRequest,\n  AnalysisResult,\n} from './types.js';\nimport { DEFAULT_CONFIG } from './types.js';\nimport { GeminiConfigError } from './errors.js';\nimport { GeminiInstaller } from './installer.js';\nimport { GeminiAuthenticator } from './authenticator.js';\nimport { GeminiExecutor } from './executor.js';\nimport { GeminiCache } from './cache.js';\nimport { RateLimiter } from './rate-limiter.js';\n\nexport class GeminiModuleManager extends EventEmitter {\n  private static instance: GeminiModuleManager | null = null;\n\n  private config: GeminiCLIConfig;\n  private installer: GeminiInstaller;\n  private authenticator: GeminiAuthenticator;\n  private executor: GeminiExecutor | null = null;\n  private cache: GeminiCache;\n  private rateLimiter: RateLimiter;\n  private initialized: boolean = false;\n\n  private constructor() {\n    super();\n    this.config = { ...DEFAULT_CONFIG };\n    this.installer = new GeminiInstaller();\n    this.authenticator = new GeminiAuthenticator(this.installer);\n    this.cache = new GeminiCache(this.config.cache);\n    this.rateLimiter = new RateLimiter(this.config.rateLimit);\n  }\n\n  /**\n   * Get singleton instance\n   */\n  static getInstance(): GeminiModuleManager {\n    if (!GeminiModuleManager.instance) {\n      GeminiModuleManager.instance = new GeminiModuleManager();\n    }\n    return GeminiModuleManager.instance;\n  }\n\n  /**\n   * Initialize the module\n   */\n  async initialize(): Promise<void> {\n    if (this.initialized) return;\n\n    // Load configuration\n    await this.loadConfig();\n\n    // Initialize cache\n    await this.cache.initialize();\n\n    this.initialized = true;\n    this.emit('initialized');\n  }\n\n  /**\n   * Enable the module\n   */\n  async enable(options: {\n    authMethod?: AuthMethod;\n    apiKey?: string;\n    vertexProject?: string;\n    vertexLocation?: string;\n    skipInstall?: boolean;\n  } = {}): Promise<void> {\n    console.log('üöÄ Enabling Gemini CLI module...');\n\n    // Ensure initialized\n    await this.initialize();\n\n    // Install if needed\n    if (!options.skipInstall) {\n      const installResult = await this.installer.ensureInstalled();\n      if (!installResult.success) {\n        throw new GeminiConfigError('Failed to install Gemini CLI');\n      }\n    }\n\n    // Authenticate\n    const authMethod = options.authMethod || 'google-login';\n    await this.authenticator.authenticate(authMethod, {\n      apiKey: options.apiKey,\n      vertexProject: options.vertexProject,\n      vertexLocation: options.vertexLocation,\n    } as Partial<GeminiCLIConfig>);\n\n    // Update config\n    this.config.enabled = true;\n    this.config.authMethod = authMethod;\n    if (options.apiKey) this.config.apiKey = options.apiKey;\n    if (options.vertexProject) this.config.vertexProject = options.vertexProject;\n    if (options.vertexLocation) this.config.vertexLocation = options.vertexLocation;\n\n    // Create executor\n    this.executor = new GeminiExecutor(\n      this.installer,\n      this.cache,\n      this.rateLimiter,\n      this.config\n    );\n\n    // Save config\n    await this.saveConfig();\n\n    console.log('‚úÖ Gemini CLI module enabled');\n    this.emit('enabled');\n  }\n\n  /**\n   * Disable the module\n   */\n  async disable(): Promise<void> {\n    console.log('‚è∏Ô∏è  Disabling Gemini CLI module...');\n\n    this.config.enabled = false;\n    this.executor = null;\n\n    await this.saveConfig();\n\n    console.log('‚úÖ Gemini CLI module disabled');\n    this.emit('disabled');\n  }\n\n  /**\n   * Eject (completely remove) the module\n   */\n  async eject(options: {\n    force?: boolean;\n    uninstall?: boolean;\n    keepConfig?: boolean;\n  } = {}): Promise<void> {\n    console.log('üóëÔ∏è  Ejecting Gemini CLI module...');\n\n    // Disable first\n    await this.disable();\n\n    // Clear cache\n    await this.cache.clear();\n\n    // Logout\n    await this.authenticator.logout();\n\n    // Uninstall if requested\n    if (options.uninstall) {\n      await this.installer.uninstall();\n    }\n\n    // Clear config unless keepConfig is set\n    if (!options.keepConfig) {\n      this.config = { ...DEFAULT_CONFIG };\n      await this.deleteConfig();\n    }\n\n    console.log('‚úÖ Gemini CLI module ejected');\n    this.emit('ejected');\n  }\n\n  /**\n   * Get module status\n   */\n  async getStatus(): Promise<ModuleStatus> {\n    const installed = await this.installer.isInstalled();\n    const authenticated = await this.authenticator.isAuthenticated();\n    const version = await this.installer.getVersion();\n    const binaryPath = await this.installer.findBinary();\n    const authMethod = await this.authenticator.getAuthMethod();\n\n    return {\n      installed,\n      enabled: this.config.enabled,\n      authenticated,\n      version,\n      authMethod: authMethod ?? undefined,\n      binaryPath: binaryPath ?? undefined,\n      quotaStatus: this.rateLimiter.getQuotaStatus(),\n      lastCheck: new Date(),\n    };\n  }\n\n  /**\n   * Check if module is enabled\n   */\n  isEnabled(): boolean {\n    return this.config.enabled;\n  }\n\n  /**\n   * Get the executor (for running analyses)\n   */\n  getExecutor(): GeminiExecutor | null {\n    return this.executor;\n  }\n\n  /**\n   * Run an analysis\n   */\n  async analyze(request: AnalysisRequest): Promise<AnalysisResult> {\n    if (!this.executor) {\n      throw new GeminiConfigError('Module not enabled. Run `claude-flow gemini enable` first.');\n    }\n    return this.executor.analyze(request);\n  }\n\n  /**\n   * Get current configuration\n   */\n  getConfig(): GeminiCLIConfig {\n    return { ...this.config };\n  }\n\n  /**\n   * Update configuration\n   */\n  async updateConfig(updates: Partial<GeminiCLIConfig>): Promise<void> {\n    this.config = { ...this.config, ...updates };\n    await this.saveConfig();\n    this.emit('config-updated', this.config);\n  }\n\n  /**\n   * Get cache instance for external access\n   */\n  getCache(): GeminiCache {\n    return this.cache;\n  }\n\n  /**\n   * Get cache statistics\n   */\n  getCacheStats(): { entries: number; size: number; hitRate: number } {\n    return this.cache.getStats();\n  }\n\n  /**\n   * Clear the cache\n   */\n  async clearCache(): Promise<void> {\n    await this.cache.clear();\n  }\n\n  // ============================================\n  // Private Methods\n  // ============================================\n\n  private getConfigPath(): string {\n    return path.join(os.homedir(), '.claude-flow', 'modules', 'gemini-cli.json');\n  }\n\n  private async loadConfig(): Promise<void> {\n    const configPath = this.getConfigPath();\n\n    try {\n      const content = await fs.readFile(configPath, 'utf-8');\n      const loaded = JSON.parse(content);\n      this.config = { ...DEFAULT_CONFIG, ...loaded };\n    } catch {\n      // Use defaults if config doesn't exist\n      this.config = { ...DEFAULT_CONFIG };\n    }\n\n    // Update child components with loaded config\n    this.cache = new GeminiCache(this.config.cache);\n    this.rateLimiter = new RateLimiter(this.config.rateLimit);\n  }\n\n  private async saveConfig(): Promise<void> {\n    const configPath = this.getConfigPath();\n    const configDir = path.dirname(configPath);\n\n    await fs.mkdir(configDir, { recursive: true });\n    await fs.writeFile(configPath, JSON.stringify(this.config, null, 2), 'utf-8');\n  }\n\n  private async deleteConfig(): Promise<void> {\n    const configPath = this.getConfigPath();\n\n    try {\n      await fs.unlink(configPath);\n    } catch {\n      // Ignore if doesn't exist\n    }\n  }\n}\n\n// Export singleton getter\nexport function getGeminiModule(): GeminiModuleManager {\n  return GeminiModuleManager.getInstance();\n}\n\n// Re-export types and components\nexport * from './types.js';\nexport * from './errors.js';\nexport { GeminiInstaller } from './installer.js';\nexport { GeminiAuthenticator } from './authenticator.js';\nexport { GeminiExecutor } from './executor.js';\nexport { GeminiCache } from './cache.js';\nexport { RateLimiter } from './rate-limiter.js';\n"],"names":["fs","path","os","EventEmitter","DEFAULT_CONFIG","GeminiConfigError","GeminiInstaller","GeminiAuthenticator","GeminiExecutor","GeminiCache","RateLimiter","GeminiModuleManager","instance","config","installer","authenticator","executor","cache","rateLimiter","initialized","rateLimit","getInstance","initialize","loadConfig","emit","enable","options","console","log","skipInstall","installResult","ensureInstalled","success","authMethod","authenticate","apiKey","vertexProject","vertexLocation","enabled","saveConfig","disable","eject","clear","logout","uninstall","keepConfig","deleteConfig","getStatus","installed","isInstalled","authenticated","isAuthenticated","version","getVersion","binaryPath","findBinary","getAuthMethod","undefined","quotaStatus","getQuotaStatus","lastCheck","Date","isEnabled","getExecutor","analyze","request","getConfig","updateConfig","updates","getCache","getCacheStats","getStats","clearCache","getConfigPath","join","homedir","configPath","content","readFile","loaded","JSON","parse","configDir","dirname","mkdir","recursive","writeFile","stringify","unlink","getGeminiModule"],"mappings":"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"}