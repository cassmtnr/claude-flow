{"version":3,"sources":["../../../../../../src/modules/gemini-cli/src/core/authenticator.ts"],"sourcesContent":["/**\n * Gemini CLI Module - Authenticator\n * Handles Google Login, API Key, and Vertex AI authentication\n */\n\nimport { spawn } from 'child_process';\nimport { promisify } from 'util';\nimport { exec } from 'child_process';\nimport * as fs from 'fs/promises';\nimport * as path from 'path';\nimport * as os from 'os';\nimport { GeminiAuthError } from './errors.js';\nimport type { AuthMethod, AuthResult, VertexAIConfig, GeminiCLIConfig } from './types.js';\nimport { GeminiInstaller } from './installer.js';\n\nconst execAsync = promisify(exec);\n\nexport class GeminiAuthenticator {\n  private installer: GeminiInstaller;\n  private credentialsPath: string;\n\n  constructor(installer: GeminiInstaller) {\n    this.installer = installer;\n    this.credentialsPath = path.join(os.homedir(), '.gemini');\n  }\n\n  /**\n   * Check if currently authenticated\n   */\n  async isAuthenticated(): Promise<boolean> {\n    try {\n      // Check for credentials file\n      const credFiles = [\n        path.join(this.credentialsPath, 'credentials.json'),\n        path.join(this.credentialsPath, 'application_default_credentials.json'),\n      ];\n\n      for (const file of credFiles) {\n        try {\n          await fs.access(file);\n          return true;\n        } catch {\n          continue;\n        }\n      }\n\n      // Check for API key in environment\n      if (process.env.GEMINI_API_KEY) {\n        return true;\n      }\n\n      // Check for Vertex AI credentials\n      if (process.env.GOOGLE_APPLICATION_CREDENTIALS) {\n        try {\n          await fs.access(process.env.GOOGLE_APPLICATION_CREDENTIALS);\n          return true;\n        } catch {\n          // File doesn't exist\n        }\n      }\n\n      return false;\n    } catch {\n      return false;\n    }\n  }\n\n  /**\n   * Get current authentication method\n   */\n  async getAuthMethod(): Promise<AuthMethod | null> {\n    if (process.env.GEMINI_API_KEY) {\n      return 'api-key';\n    }\n\n    if (process.env.GOOGLE_APPLICATION_CREDENTIALS) {\n      return 'vertex-ai';\n    }\n\n    const credFile = path.join(this.credentialsPath, 'credentials.json');\n    try {\n      await fs.access(credFile);\n      return 'google-login';\n    } catch {\n      return null;\n    }\n  }\n\n  /**\n   * Authenticate using the specified method\n   */\n  async authenticate(\n    method: AuthMethod,\n    config?: Partial<GeminiCLIConfig>\n  ): Promise<AuthResult> {\n    switch (method) {\n      case 'google-login':\n        return this.authenticateWithGoogle();\n      case 'api-key':\n        return this.authenticateWithApiKey(config?.apiKey);\n      case 'vertex-ai':\n        if (!config?.vertexProject) {\n          throw new GeminiAuthError('Vertex AI project is required', 'vertex-ai');\n        }\n        return this.authenticateWithVertexAI({\n          project: config.vertexProject,\n          location: config.vertexLocation || 'us-central1',\n        });\n      default:\n        throw new GeminiAuthError(`Unknown authentication method: ${method}`, method);\n    }\n  }\n\n  /**\n   * Google OAuth login\n   */\n  async authenticateWithGoogle(): Promise<AuthResult> {\n    console.log('üîê Starting Google OAuth login...');\n\n    const binaryPath = await this.installer.findBinary();\n    if (!binaryPath) {\n      throw new GeminiAuthError('Gemini CLI not installed', 'google-login');\n    }\n\n    return new Promise((resolve, reject) => {\n      const child = spawn(binaryPath, ['auth', 'login'], {\n        stdio: ['inherit', 'pipe', 'pipe'],\n      });\n\n      let stderr = '';\n\n      child.stdout?.on('data', (data) => {\n        process.stdout.write(data);\n      });\n\n      child.stderr?.on('data', (data) => {\n        stderr += data.toString();\n        process.stderr.write(data);\n      });\n\n      child.on('close', async (code) => {\n        if (code === 0) {\n          console.log('‚úÖ Google authentication successful');\n          resolve({\n            success: true,\n            method: 'google-login',\n          });\n        } else {\n          reject(\n            new GeminiAuthError(\n              `Google login failed: ${stderr || 'Unknown error'}`,\n              'google-login',\n              { exitCode: code }\n            )\n          );\n        }\n      });\n\n      child.on('error', (error) => {\n        reject(\n          new GeminiAuthError(\n            `Failed to start auth process: ${error.message}`,\n            'google-login'\n          )\n        );\n      });\n    });\n  }\n\n  /**\n   * API Key authentication\n   */\n  async authenticateWithApiKey(apiKey?: string): Promise<AuthResult> {\n    const key = apiKey || process.env.GEMINI_API_KEY;\n\n    if (!key) {\n      throw new GeminiAuthError(\n        'API key is required. Provide via --api-key or GEMINI_API_KEY environment variable',\n        'api-key'\n      );\n    }\n\n    console.log('üîê Validating API key...');\n\n    try {\n      // Test the API key with a simple request\n      const testResult = await this.testApiKey(key);\n\n      if (!testResult.valid) {\n        throw new GeminiAuthError(\n          `Invalid API key: ${testResult.error}`,\n          'api-key'\n        );\n      }\n\n      // Store in environment for this session\n      process.env.GEMINI_API_KEY = key;\n\n      console.log('‚úÖ API key validated successfully');\n\n      return {\n        success: true,\n        method: 'api-key',\n      };\n    } catch (error) {\n      if (error instanceof GeminiAuthError) throw error;\n      throw new GeminiAuthError(\n        `API key validation failed: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        'api-key'\n      );\n    }\n  }\n\n  /**\n   * Vertex AI authentication\n   */\n  async authenticateWithVertexAI(config: VertexAIConfig): Promise<AuthResult> {\n    console.log('üîê Configuring Vertex AI authentication...');\n\n    if (!config.project) {\n      throw new GeminiAuthError(\n        'Vertex AI project ID is required',\n        'vertex-ai'\n      );\n    }\n\n    // Check for service account credentials\n    const saPath = config.serviceAccountPath || process.env.GOOGLE_APPLICATION_CREDENTIALS;\n\n    if (!saPath) {\n      throw new GeminiAuthError(\n        'Service account credentials required. Set GOOGLE_APPLICATION_CREDENTIALS or --sa-path',\n        'vertex-ai'\n      );\n    }\n\n    // Verify credentials file exists\n    try {\n      await fs.access(saPath);\n    } catch {\n      throw new GeminiAuthError(\n        `Service account file not found: ${saPath}`,\n        'vertex-ai'\n      );\n    }\n\n    // Validate credentials format\n    try {\n      const content = await fs.readFile(saPath, 'utf-8');\n      const creds = JSON.parse(content);\n\n      if (!creds.type || !creds.project_id) {\n        throw new GeminiAuthError(\n          'Invalid service account file format',\n          'vertex-ai'\n        );\n      }\n    } catch (error) {\n      if (error instanceof GeminiAuthError) throw error;\n      throw new GeminiAuthError(\n        `Failed to parse service account file: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        'vertex-ai'\n      );\n    }\n\n    // Set environment variables\n    process.env.GOOGLE_APPLICATION_CREDENTIALS = saPath;\n    process.env.GOOGLE_CLOUD_PROJECT = config.project;\n    process.env.GOOGLE_CLOUD_LOCATION = config.location;\n\n    console.log('‚úÖ Vertex AI authentication configured');\n    console.log(`   Project: ${config.project}`);\n    console.log(`   Location: ${config.location}`);\n\n    return {\n      success: true,\n      method: 'vertex-ai',\n    };\n  }\n\n  /**\n   * Logout / clear credentials\n   */\n  async logout(): Promise<void> {\n    console.log('üîì Clearing authentication...');\n\n    // Clear environment variables\n    delete process.env.GEMINI_API_KEY;\n    delete process.env.GOOGLE_APPLICATION_CREDENTIALS;\n    delete process.env.GOOGLE_CLOUD_PROJECT;\n    delete process.env.GOOGLE_CLOUD_LOCATION;\n\n    // Try to run gemini auth logout\n    const binaryPath = await this.installer.findBinary();\n    if (binaryPath) {\n      try {\n        await execAsync(`\"${binaryPath}\" auth logout`);\n      } catch {\n        // Ignore errors\n      }\n    }\n\n    // Clear local credentials\n    try {\n      await fs.rm(this.credentialsPath, { recursive: true, force: true });\n    } catch {\n      // Ignore if doesn't exist\n    }\n\n    console.log('‚úÖ Authentication cleared');\n  }\n\n  // ============================================\n  // Private Methods\n  // ============================================\n\n  private async testApiKey(key: string): Promise<{ valid: boolean; error?: string }> {\n    try {\n      // Make a minimal API request to test the key\n      const response = await fetch(\n        `https://generativelanguage.googleapis.com/v1/models?key=${key}`,\n        {\n          method: 'GET',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n        }\n      );\n\n      if (response.ok) {\n        return { valid: true };\n      }\n\n      const errorResponse = await response.json() as { error?: { message?: string } };\n      return {\n        valid: false,\n        error: errorResponse.error?.message || `HTTP ${response.status}`,\n      };\n    } catch (err) {\n      return {\n        valid: false,\n        error: err instanceof Error ? err.message : 'Unknown error',\n      };\n    }\n  }\n}\n"],"names":["spawn","promisify","exec","fs","path","os","GeminiAuthError","execAsync","GeminiAuthenticator","installer","credentialsPath","join","homedir","isAuthenticated","credFiles","file","access","process","env","GEMINI_API_KEY","GOOGLE_APPLICATION_CREDENTIALS","getAuthMethod","credFile","authenticate","method","config","authenticateWithGoogle","authenticateWithApiKey","apiKey","vertexProject","authenticateWithVertexAI","project","location","vertexLocation","console","log","binaryPath","findBinary","Promise","resolve","reject","child","stdio","stderr","stdout","on","data","write","toString","code","success","exitCode","error","message","key","testResult","testApiKey","valid","Error","saPath","serviceAccountPath","content","readFile","creds","JSON","parse","type","project_id","GOOGLE_CLOUD_PROJECT","GOOGLE_CLOUD_LOCATION","logout","rm","recursive","force","response","fetch","headers","ok","errorResponse","json","status","err"],"mappings":"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"}