{"version":3,"sources":["../../../../../../src/modules/gemini-cli/src/core/installer.ts"],"sourcesContent":["/**\n * Gemini CLI Module - Installer\n * Handles detection, installation, and version management\n */\n\nimport { exec, execSync } from 'child_process';\nimport { promisify } from 'util';\nimport * as fs from 'fs/promises';\nimport * as path from 'path';\nimport * as os from 'os';\nimport { GeminiInstallError } from './errors.js';\nimport type { InstallResult, PlatformInfo } from './types.js';\n\nconst execAsync = promisify(exec);\n\nexport class GeminiInstaller {\n  private platformInfo: PlatformInfo;\n  private cachedVersion: string | null = null;\n  private cachedPath: string | null = null;\n\n  constructor() {\n    this.platformInfo = this.detectPlatform();\n  }\n\n  /**\n   * Check if Gemini CLI is installed\n   */\n  async isInstalled(): Promise<boolean> {\n    const binaryPath = await this.findBinary();\n    return binaryPath !== null;\n  }\n\n  /**\n   * Find the Gemini CLI binary path\n   */\n  async findBinary(): Promise<string | null> {\n    if (this.cachedPath) return this.cachedPath;\n\n    // Try 'which' command first (Unix) or 'where' (Windows)\n    const whichCmd = this.platformInfo.os === 'win32' ? 'where' : 'which';\n\n    try {\n      const { stdout } = await execAsync(`${whichCmd} gemini`);\n      const binaryPath = stdout.trim().split('\\n')[0];\n\n      if (binaryPath && await this.verifyBinary(binaryPath)) {\n        this.cachedPath = binaryPath;\n        return binaryPath;\n      }\n    } catch {\n      // Not found via which/where, check common paths\n    }\n\n    // Check common installation paths\n    const commonPaths = this.getCommonPaths();\n\n    for (const p of commonPaths) {\n      if (await this.verifyBinary(p)) {\n        this.cachedPath = p;\n        return p;\n      }\n    }\n\n    return null;\n  }\n\n  /**\n   * Get installed version\n   */\n  async getVersion(): Promise<string | undefined> {\n    if (this.cachedVersion) return this.cachedVersion;\n\n    const binaryPath = await this.findBinary();\n    if (!binaryPath) return undefined;\n\n    try {\n      const { stdout } = await execAsync(`\"${binaryPath}\" --version`);\n      const version = stdout.trim().match(/(\\d+\\.\\d+\\.\\d+)/)?.[1];\n      if (version) {\n        this.cachedVersion = version;\n        return version;\n      }\n    } catch {\n      // Version check failed\n    }\n\n    return undefined;\n  }\n\n  /**\n   * Check if installed version meets minimum requirement\n   */\n  async checkMinVersion(minVersion: string): Promise<boolean> {\n    const currentVersion = await this.getVersion();\n    if (!currentVersion) return false;\n\n    return this.compareVersions(currentVersion, minVersion) >= 0;\n  }\n\n  /**\n   * Ensure Gemini CLI is installed, install if not\n   */\n  async ensureInstalled(): Promise<InstallResult> {\n    if (await this.isInstalled()) {\n      const version = await this.getVersion();\n      const binaryPath = await this.findBinary();\n\n      return {\n        success: true,\n        version,\n        path: binaryPath ?? undefined,\n      };\n    }\n\n    return this.install();\n  }\n\n  /**\n   * Install Gemini CLI\n   */\n  async install(): Promise<InstallResult> {\n    console.log('üì¶ Installing Gemini CLI...');\n\n    try {\n      // Use npm to install globally (Gemini CLI by Google)\n      await execAsync(\n        'npm install -g @google/gemini-cli',\n        { timeout: 120000 } // 2 minute timeout\n      );\n\n      // Clear cached values\n      this.cachedPath = null;\n      this.cachedVersion = null;\n\n      // Verify installation\n      if (await this.isInstalled()) {\n        const version = await this.getVersion();\n        const binaryPath = await this.findBinary();\n\n        console.log(`‚úÖ Gemini CLI installed successfully (v${version})`);\n\n        return {\n          success: true,\n          version,\n          path: binaryPath ?? undefined,\n        };\n      }\n\n      throw new Error('Installation completed but binary not found');\n    } catch (error) {\n      const message = error instanceof Error ? error.message : 'Unknown error';\n      throw new GeminiInstallError(`Failed to install Gemini CLI: ${message}`, {\n        originalError: message,\n      });\n    }\n  }\n\n  /**\n   * Uninstall Gemini CLI\n   */\n  async uninstall(): Promise<void> {\n    console.log('üóëÔ∏è  Uninstalling Gemini CLI...');\n\n    try {\n      await execAsync('npm uninstall -g @google/gemini-cli', { timeout: 60000 });\n\n      // Clear cached values\n      this.cachedPath = null;\n      this.cachedVersion = null;\n\n      // Clear credentials\n      const geminiDir = path.join(os.homedir(), '.gemini');\n      try {\n        await fs.rm(geminiDir, { recursive: true, force: true });\n      } catch {\n        // Ignore if doesn't exist\n      }\n\n      console.log('‚úÖ Gemini CLI uninstalled successfully');\n    } catch (error) {\n      const message = error instanceof Error ? error.message : 'Unknown error';\n      throw new GeminiInstallError(`Failed to uninstall Gemini CLI: ${message}`);\n    }\n  }\n\n  /**\n   * Update Gemini CLI to latest version\n   */\n  async update(): Promise<InstallResult> {\n    console.log('üîÑ Updating Gemini CLI...');\n\n    try {\n      await execAsync('npm update -g @google/gemini-cli', { timeout: 120000 });\n\n      // Clear cached values\n      this.cachedPath = null;\n      this.cachedVersion = null;\n\n      const version = await this.getVersion();\n      const binaryPath = await this.findBinary();\n\n      console.log(`‚úÖ Gemini CLI updated to v${version}`);\n\n      return {\n        success: true,\n        version,\n        path: binaryPath ?? undefined,\n      };\n    } catch (error) {\n      const message = error instanceof Error ? error.message : 'Unknown error';\n      throw new GeminiInstallError(`Failed to update Gemini CLI: ${message}`);\n    }\n  }\n\n  /**\n   * Get installation instructions for manual install\n   */\n  getInstallInstructions(): string {\n    return `\nTo install Gemini CLI manually:\n\n1. Using npm (recommended):\n   npm install -g @google/gemini-cli\n\n2. Verify installation:\n   gemini --version\n\n3. Authenticate:\n   gemini auth login\n\nFor more information, visit:\nhttps://github.com/google-gemini/gemini-cli\n    `.trim();\n  }\n\n  /**\n   * Get platform information\n   */\n  getPlatformInfo(): PlatformInfo {\n    return { ...this.platformInfo };\n  }\n\n  // ============================================\n  // Private Methods\n  // ============================================\n\n  private detectPlatform(): PlatformInfo {\n    return {\n      os: os.platform() as 'darwin' | 'linux' | 'win32',\n      arch: os.arch() as 'x64' | 'arm64',\n      shell: process.env.SHELL || (os.platform() === 'win32' ? 'cmd.exe' : '/bin/bash'),\n      homeDir: os.homedir(),\n      npmGlobalDir: this.getNpmGlobalDir(),\n    };\n  }\n\n  private getNpmGlobalDir(): string {\n    try {\n      return execSync('npm root -g', { encoding: 'utf-8' }).trim();\n    } catch {\n      // Fallback to common paths\n      if (os.platform() === 'win32') {\n        return path.join(process.env.APPDATA || '', 'npm', 'node_modules');\n      }\n      return '/usr/local/lib/node_modules';\n    }\n  }\n\n  private getCommonPaths(): string[] {\n    const home = os.homedir();\n    const isWindows = os.platform() === 'win32';\n    const ext = isWindows ? '.cmd' : '';\n\n    const paths: string[] = [];\n\n    if (isWindows) {\n      paths.push(\n        path.join(process.env.APPDATA || '', 'npm', `gemini${ext}`),\n        path.join(process.env.LOCALAPPDATA || '', 'npm', `gemini${ext}`),\n        `C:\\\\Program Files\\\\nodejs\\\\gemini${ext}`,\n      );\n    } else {\n      paths.push(\n        path.join(home, '.local', 'bin', 'gemini'),\n        '/usr/local/bin/gemini',\n        '/usr/bin/gemini',\n        path.join(home, '.npm-global', 'bin', 'gemini'),\n        path.join(home, 'n', 'bin', 'gemini'),\n      );\n    }\n\n    return paths;\n  }\n\n  private async verifyBinary(binaryPath: string): Promise<boolean> {\n    try {\n      await fs.access(binaryPath, fs.constants.X_OK);\n      return true;\n    } catch {\n      return false;\n    }\n  }\n\n  private compareVersions(v1: string, v2: string): number {\n    const parts1 = v1.split('.').map(Number);\n    const parts2 = v2.split('.').map(Number);\n\n    for (let i = 0; i < Math.max(parts1.length, parts2.length); i++) {\n      const p1 = parts1[i] || 0;\n      const p2 = parts2[i] || 0;\n\n      if (p1 > p2) return 1;\n      if (p1 < p2) return -1;\n    }\n\n    return 0;\n  }\n}\n"],"names":["exec","execSync","promisify","fs","path","os","GeminiInstallError","execAsync","GeminiInstaller","platformInfo","cachedVersion","cachedPath","detectPlatform","isInstalled","binaryPath","findBinary","whichCmd","stdout","trim","split","verifyBinary","commonPaths","getCommonPaths","p","getVersion","undefined","version","match","checkMinVersion","minVersion","currentVersion","compareVersions","ensureInstalled","success","install","console","log","timeout","Error","error","message","originalError","uninstall","geminiDir","join","homedir","rm","recursive","force","update","getInstallInstructions","getPlatformInfo","platform","arch","shell","process","env","SHELL","homeDir","npmGlobalDir","getNpmGlobalDir","encoding","APPDATA","home","isWindows","ext","paths","push","LOCALAPPDATA","access","constants","X_OK","v1","v2","parts1","map","Number","parts2","i","Math","max","length","p1","p2"],"mappings":"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"}