{"version":3,"sources":["../../../../../../src/modules/gemini-cli/src/mcp/provider.ts"],"sourcesContent":["/**\n * Gemini CLI MCP Provider\n *\n * Implements the MCP server integration for the Gemini CLI module.\n * Registers the 5 analysis tools and routes requests to the executor.\n */\n\nimport type {\n  GeminiToolDefinition,\n  CodebaseAnalyzeInput,\n  ArchitectureMapInput,\n  SecurityScanInput,\n  DependencyAnalyzeInput,\n  CoverageAssessInput,\n} from './tools.js';\nimport { GeminiCLIToolDefinitions, getToolDefinition } from './tools.js';\nimport { getGeminiModule } from '../core/index.js';\nimport type { AnalysisResult } from '../core/types.js';\nimport { GeminiExecutionError } from '../core/errors.js';\n\n// ============================================\n// MCP Types (minimal subset for integration)\n// ============================================\n\nexport interface MCPToolRequest {\n  toolId: string;\n  input: Record<string, unknown>;\n  context?: MCPContext;\n}\n\nexport interface MCPToolResponse {\n  success: boolean;\n  content: string | Record<string, unknown>;\n  isError?: boolean;\n  metadata?: Record<string, unknown>;\n}\n\nexport interface MCPContext {\n  sessionId?: string;\n  userId?: string;\n  conversationHistory?: string[];\n  currentQuery?: string;\n}\n\nexport interface MCPServerConfig {\n  name: string;\n  version: string;\n  capabilities: string[];\n}\n\n// ============================================\n// Tool Handler Type\n// ============================================\n\ntype ToolHandler = (input: Record<string, unknown>, context?: MCPContext) => Promise<MCPToolResponse>;\n\n// ============================================\n// Provider Class\n// ============================================\n\nexport class GeminiCLIMCPProvider {\n  private handlers: Map<string, ToolHandler> = new Map();\n  private initialized: boolean = false;\n\n  constructor() {\n    this.registerHandlers();\n  }\n\n  // ============================================\n  // Server Configuration\n  // ============================================\n\n  getServerConfig(): MCPServerConfig {\n    return {\n      name: 'gemini-cli',\n      version: '1.0.0',\n      capabilities: ['tools', 'progressive-disclosure'],\n    };\n  }\n\n  // ============================================\n  // Tool Discovery\n  // ============================================\n\n  getToolDefinitions(): GeminiToolDefinition[] {\n    return GeminiCLIToolDefinitions;\n  }\n\n  getToolsByDisclosure(\n    level: 'basic' | 'standard' | 'full',\n    context?: MCPContext\n  ): GeminiToolDefinition[] {\n    const levelPriority = { basic: 1, standard: 2, full: 3 };\n    const currentLevel = levelPriority[level];\n\n    return GeminiCLIToolDefinitions.filter((tool) => {\n      const toolLevel = levelPriority[tool.disclosure.level];\n      if (toolLevel > currentLevel) return false;\n\n      // Check if any trigger words match the current query\n      if (context?.currentQuery) {\n        const query = context.currentQuery.toLowerCase();\n        return tool.disclosure.triggers.some((trigger) => query.includes(trigger.toLowerCase()));\n      }\n\n      return true;\n    }).sort((a, b) => b.disclosure.priority - a.disclosure.priority);\n  }\n\n  // ============================================\n  // Tool Execution\n  // ============================================\n\n  async executeTool(request: MCPToolRequest): Promise<MCPToolResponse> {\n    const { toolId, input, context } = request;\n\n    // Ensure module is initialized\n    if (!this.initialized) {\n      await this.initialize();\n    }\n\n    // Get handler\n    const handler = this.handlers.get(toolId);\n    if (!handler) {\n      return {\n        success: false,\n        isError: true,\n        content: `Unknown tool: ${toolId}. Available tools: ${Array.from(this.handlers.keys()).join(', ')}`,\n      };\n    }\n\n    // Check if module is enabled\n    const module = getGeminiModule();\n    if (!module.isEnabled()) {\n      return {\n        success: false,\n        isError: true,\n        content:\n          'Gemini CLI module is not enabled. Run `claude-flow gemini enable` to enable it first.',\n      };\n    }\n\n    try {\n      return await handler(input, context);\n    } catch (err) {\n      const error = err instanceof Error ? err : new Error(String(err));\n      return {\n        success: false,\n        isError: true,\n        content: `Tool execution failed: ${error.message}`,\n        metadata: {\n          toolId,\n          error: error.name,\n        },\n      };\n    }\n  }\n\n  // ============================================\n  // Initialization\n  // ============================================\n\n  async initialize(): Promise<void> {\n    if (this.initialized) return;\n\n    const module = getGeminiModule();\n    await module.initialize();\n    this.initialized = true;\n  }\n\n  // ============================================\n  // Handler Registration\n  // ============================================\n\n  private registerHandlers(): void {\n    // 1. Codebase Analyze\n    this.handlers.set('codebase_analyze', this.handleCodebaseAnalyze.bind(this));\n\n    // 2. Architecture Map\n    this.handlers.set('architecture_map', this.handleArchitectureMap.bind(this));\n\n    // 3. Security Scan\n    this.handlers.set('security_scan', this.handleSecurityScan.bind(this));\n\n    // 4. Dependency Analyze\n    this.handlers.set('dependency_analyze', this.handleDependencyAnalyze.bind(this));\n\n    // 5. Coverage Assess\n    this.handlers.set('coverage_assess', this.handleCoverageAssess.bind(this));\n  }\n\n  // ============================================\n  // Individual Tool Handlers\n  // ============================================\n\n  private async handleCodebaseAnalyze(\n    input: Record<string, unknown>,\n    _context?: MCPContext\n  ): Promise<MCPToolResponse> {\n    const typedInput = input as unknown as CodebaseAnalyzeInput;\n    const module = getGeminiModule();\n\n    const result = await module.analyze({\n      type: 'codebase',\n      target: typedInput.paths,\n      query: typedInput.query,\n      depth: typedInput.depth || 'moderate',\n      outputFormat: typedInput.outputFormat || 'markdown',\n      storeInMemory: typedInput.storeInMemory,\n    });\n\n    return this.formatAnalysisResult(result, 'codebase_analyze');\n  }\n\n  private async handleArchitectureMap(\n    input: Record<string, unknown>,\n    _context?: MCPContext\n  ): Promise<MCPToolResponse> {\n    const typedInput = input as unknown as ArchitectureMapInput;\n    const module = getGeminiModule();\n    const executor = module.getExecutor();\n\n    if (!executor) {\n      throw new GeminiExecutionError('Executor not available', 'architecture');\n    }\n\n    // Build focus areas based on input options\n    const focus: string[] = ['components', 'layers'];\n    if (typedInput.includeDataFlows ?? true) {\n      focus.push('data-flows');\n    }\n    if (typedInput.includeDependencies ?? true) {\n      focus.push('dependencies');\n    }\n\n    const result = await executor.architectureMap(typedInput.path, {\n      depth: typedInput.depth || 'comprehensive',\n      focus,\n    });\n\n    return this.formatAnalysisResult(result, 'architecture_map');\n  }\n\n  private async handleSecurityScan(\n    input: Record<string, unknown>,\n    _context?: MCPContext\n  ): Promise<MCPToolResponse> {\n    const typedInput = input as unknown as SecurityScanInput;\n    const module = getGeminiModule();\n    const executor = module.getExecutor();\n\n    if (!executor) {\n      throw new GeminiExecutionError('Executor not available', 'security');\n    }\n\n    // Convert scanTypes to focus areas (cast to string[] for flexibility)\n    const focus: string[] = [...(typedInput.scanTypes || ['vulnerabilities', 'secrets', 'misconfig'])];\n    // Add severity threshold as a focus item if not low\n    if (typedInput.severityThreshold && typedInput.severityThreshold !== 'low') {\n      focus.push(`severity:${typedInput.severityThreshold}`);\n    }\n\n    const result = await executor.securityScan(typedInput.path, {\n      depth: typedInput.depth || 'deep',\n      focus,\n    });\n\n    return this.formatAnalysisResult(result, 'security_scan');\n  }\n\n  private async handleDependencyAnalyze(\n    input: Record<string, unknown>,\n    _context?: MCPContext\n  ): Promise<MCPToolResponse> {\n    const typedInput = input as unknown as DependencyAnalyzeInput;\n    const module = getGeminiModule();\n\n    const result = await module.analyze({\n      type: 'dependencies',\n      target: [typedInput.path],\n      outputFormat: typedInput.outputFormat || 'markdown',\n    });\n\n    // Add dependency-specific metadata\n    return {\n      ...this.formatAnalysisResult(result, 'dependency_analyze'),\n      metadata: {\n        toolId: 'dependency_analyze',\n        checkOutdated: typedInput.checkOutdated ?? true,\n        checkVulnerabilities: typedInput.checkVulnerabilities ?? true,\n        checkLicenses: typedInput.checkLicenses ?? true,\n      },\n    };\n  }\n\n  private async handleCoverageAssess(\n    input: Record<string, unknown>,\n    _context?: MCPContext\n  ): Promise<MCPToolResponse> {\n    const typedInput = input as unknown as CoverageAssessInput;\n    const module = getGeminiModule();\n\n    const result = await module.analyze({\n      type: 'coverage',\n      target: [typedInput.path],\n      depth: typedInput.depth || 'moderate',\n      outputFormat: typedInput.outputFormat || 'markdown',\n    });\n\n    return {\n      ...this.formatAnalysisResult(result, 'coverage_assess'),\n      metadata: {\n        toolId: 'coverage_assess',\n        testDirectory: typedInput.testDirectory,\n        focusAreas: typedInput.focusAreas,\n      },\n    };\n  }\n\n  // ============================================\n  // Result Formatting\n  // ============================================\n\n  private formatAnalysisResult(result: AnalysisResult, toolId: string): MCPToolResponse {\n    if (!result.success) {\n      return {\n        success: false,\n        isError: true,\n        content: result.errors?.join('\\n') || 'Analysis failed',\n        metadata: {\n          toolId,\n          duration: result.duration,\n        },\n      };\n    }\n\n    // Format as markdown for human-readable output\n    const content = this.formatMarkdownOutput(result, toolId);\n\n    return {\n      success: true,\n      content,\n      metadata: {\n        toolId,\n        duration: result.duration,\n        filesAnalyzed: result.metrics.filesAnalyzed,\n        linesOfCode: result.metrics.linesOfCode,\n        findingsCount: result.findings.length,\n        recommendationsCount: result.recommendations.length,\n      },\n    };\n  }\n\n  private formatMarkdownOutput(result: AnalysisResult, toolId: string): string {\n    const toolDef = getToolDefinition(toolId);\n    const toolName = toolDef?.name || toolId;\n\n    const sections: string[] = [];\n\n    // Header\n    sections.push(`# ${toolName} Results\\n`);\n\n    // Summary\n    sections.push(`## Summary\\n\\n${result.summary}\\n`);\n\n    // Metrics\n    sections.push(`## Metrics\\n`);\n    sections.push(`- **Files Analyzed**: ${result.metrics.filesAnalyzed}`);\n    sections.push(`- **Lines of Code**: ${result.metrics.linesOfCode}`);\n    sections.push(`- **Duration**: ${result.duration}ms\\n`);\n\n    // Findings\n    if (result.findings.length > 0) {\n      sections.push(`## Findings (${result.findings.length})\\n`);\n\n      // Group by severity\n      const bySeverity = this.groupBySeverity(result.findings);\n\n      for (const [severity, findings] of Object.entries(bySeverity)) {\n        if (findings.length === 0) continue;\n        sections.push(`### ${severity.charAt(0).toUpperCase() + severity.slice(1)} (${findings.length})\\n`);\n\n        for (const finding of findings.slice(0, 10)) {\n          const icon = this.getSeverityIcon(finding.severity);\n          sections.push(`${icon} **${finding.message}**`);\n          if (finding.location !== 'unknown') {\n            sections.push(`   - Location: \\`${finding.location}\\``);\n          }\n          if (finding.suggestion) {\n            sections.push(`   - Suggestion: ${finding.suggestion}`);\n          }\n          sections.push('');\n        }\n\n        if (findings.length > 10) {\n          sections.push(`*... and ${findings.length - 10} more ${severity} findings*\\n`);\n        }\n      }\n    }\n\n    // Recommendations\n    if (result.recommendations.length > 0) {\n      sections.push(`## Recommendations\\n`);\n      for (const rec of result.recommendations.slice(0, 5)) {\n        sections.push(`- ${rec}`);\n      }\n      if (result.recommendations.length > 5) {\n        sections.push(`\\n*... and ${result.recommendations.length - 5} more recommendations*`);\n      }\n      sections.push('');\n    }\n\n    return sections.join('\\n');\n  }\n\n  private groupBySeverity(\n    findings: AnalysisResult['findings']\n  ): Record<string, AnalysisResult['findings']> {\n    const groups: Record<string, AnalysisResult['findings']> = {\n      critical: [],\n      high: [],\n      medium: [],\n      low: [],\n      info: [],\n    };\n\n    for (const finding of findings) {\n      if (groups[finding.severity]) {\n        groups[finding.severity].push(finding);\n      } else {\n        groups.info.push(finding);\n      }\n    }\n\n    return groups;\n  }\n\n  private getSeverityIcon(severity: string): string {\n    switch (severity) {\n      case 'critical':\n        return 'ðŸ”´';\n      case 'high':\n        return 'ðŸŸ ';\n      case 'medium':\n        return 'ðŸŸ¡';\n      case 'low':\n        return 'ðŸŸ¢';\n      default:\n        return 'â„¹ï¸';\n    }\n  }\n}\n\n// ============================================\n// Singleton Instance\n// ============================================\n\nlet providerInstance: GeminiCLIMCPProvider | null = null;\n\nexport function getGeminiCLIMCPProvider(): GeminiCLIMCPProvider {\n  if (!providerInstance) {\n    providerInstance = new GeminiCLIMCPProvider();\n  }\n  return providerInstance;\n}\n\n// ============================================\n// MCP Server Registration Helper\n// ============================================\n\nexport interface MCPServerRegistration {\n  name: string;\n  version: string;\n  tools: GeminiToolDefinition[];\n  execute: (request: MCPToolRequest) => Promise<MCPToolResponse>;\n}\n\nexport function createMCPServerRegistration(): MCPServerRegistration {\n  const provider = getGeminiCLIMCPProvider();\n  const config = provider.getServerConfig();\n\n  return {\n    name: config.name,\n    version: config.version,\n    tools: provider.getToolDefinitions(),\n    execute: (request) => provider.executeTool(request),\n  };\n}\n"],"names":["GeminiCLIToolDefinitions","getToolDefinition","getGeminiModule","GeminiExecutionError","GeminiCLIMCPProvider","handlers","Map","initialized","registerHandlers","getServerConfig","name","version","capabilities","getToolDefinitions","getToolsByDisclosure","level","context","levelPriority","basic","standard","full","currentLevel","filter","tool","toolLevel","disclosure","currentQuery","query","toLowerCase","triggers","some","trigger","includes","sort","a","b","priority","executeTool","request","toolId","input","initialize","handler","get","success","isError","content","Array","from","keys","join","module","isEnabled","err","error","Error","String","message","metadata","set","handleCodebaseAnalyze","bind","handleArchitectureMap","handleSecurityScan","handleDependencyAnalyze","handleCoverageAssess","_context","typedInput","result","analyze","type","target","paths","depth","outputFormat","storeInMemory","formatAnalysisResult","executor","getExecutor","focus","includeDataFlows","push","includeDependencies","architectureMap","path","scanTypes","severityThreshold","securityScan","checkOutdated","checkVulnerabilities","checkLicenses","testDirectory","focusAreas","errors","duration","formatMarkdownOutput","filesAnalyzed","metrics","linesOfCode","findingsCount","findings","length","recommendationsCount","recommendations","toolDef","toolName","sections","summary","bySeverity","groupBySeverity","severity","Object","entries","charAt","toUpperCase","slice","finding","icon","getSeverityIcon","location","suggestion","rec","groups","critical","high","medium","low","info","providerInstance","getGeminiCLIMCPProvider","createMCPServerRegistration","provider","config","tools","execute"],"mappings":"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"}